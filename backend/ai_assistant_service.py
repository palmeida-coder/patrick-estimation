import os
import uuid
from datetime import datetime, timedelta
from typing import Dict, List, Any, Optional
import logging
import asyncio
from dotenv import load_dotenv
from emergentintegrations.llm.chat import LlmChat, UserMessage
from motor.motor_asyncio import AsyncIOMotorDatabase

load_dotenv()
logger = logging.getLogger(__name__)

class EfficityAIAssistant:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.db = db
        self.api_key = os.getenv('EMERGENT_LLM_KEY')
        self.chat = None
        self._initialize_assistant()
    
    def _initialize_assistant(self):
        """Initialiser l'assistant IA Efficity"""
        try:
            if not self.api_key:
                raise ValueError("‚ùå EMERGENT_LLM_KEY non trouv√©e")
            
            # Utiliser gpt-4o pour un assistant plus intelligent
            self.chat = LlmChat(
                api_key=self.api_key,
                session_id="efficity-assistant-patrick",
                system_message="""Tu es PATRICK IA, l'assistant personnel intelligent de Patrick Almeida, directeur de l'agence Efficity Lyon.

üè† EXPERTISE EFFICITY LYON :
- Agence : 6, place des Tapis, Lyon 4√®me
- Directeur : Patrick Almeida (06 82 05 28 24, palmeida@efficity.com)
- Secteur : Premi√®re agence Efficity √† Lyon
- Exp√©rience : Ex-directeur St√©phane Plaza Immobilier

üéØ MARCH√â LYON (Prix 2024) :
- Lyon 1er (Presqu'√Æle) : 5500-6500‚Ç¨/m¬≤
- Lyon 2√®me (Bellecour) : 5000-6000‚Ç¨/m¬≤ 
- Lyon 3√®me (Part-Dieu) : 4200-5200‚Ç¨/m¬≤
- Lyon 4√®me (Croix-Rousse) : 4500-5500‚Ç¨/m¬≤
- Lyon 6√®me (Foch) : 5500-7000‚Ç¨/m¬≤
- Lyon 7√®me (Garibaldi) : 4000-5000‚Ç¨/m¬≤
- Villeurbanne : 3500-4500‚Ç¨/m¬≤

üíº TES CAPACIT√âS :
- Analyser les leads et recommander actions pr√©cises
- Estimer budgets et potentiel par secteur
- Planifier la prospection quotidienne
- Conseiller sur timing et approche commerciale
- Pr√©dire les meilleures opportunit√©s

üó£Ô∏è TON STYLE :
- Tutoie Patrick (familier mais professionnel)
- R√©ponds de mani√®re actionnable et pr√©cise
- Inclus horaires, montants, d√©lais concrets
- Adapte tes conseils au profil du lead
- Reste focus business et ROI

‚ö° TOUJOURS INCLURE :
- Actions pr√©cises √† faire (avec timing)
- Estimation financi√®re si pertinente
- Priorit√© (Urgent/Important/Routine)
- Pourquoi cette recommandation

Exemple de r√©ponse :
"üéØ CONSEIL PATRICK : Appelle Marie Dubois AUJOURD'HUI entre 14h-16h. 
üí∞ Son profil Lyon 2√®me + source SeLoger = potentiel 450K‚Ç¨ 
‚ö° Action : Propose estimation gratuite sous 48h, mentionne la raret√© Bellecour
üèÜ Priorit√© : URGENT - Lead chaud d√©tect√©"

Tu as acc√®s aux donn√©es de ses leads via mes analyses. Sois son bras droit commercial intelligent !"""
            ).with_model("openai", "gpt-4o")
            
            logger.info("‚úÖ Assistant IA Efficity Patrick initialis√© avec gpt-4o")
            
        except Exception as e:
            logger.error(f"‚ùå Erreur initialisation Assistant IA: {str(e)}")
            raise
    
    async def ask_assistant(self, question: str, context_data: Optional[Dict] = None) -> str:
        """Poser une question √† l'assistant IA Patrick"""
        try:
            # Enrichir la question avec le contexte des leads
            enriched_question = await self._enrich_question_with_context(question, context_data)
            
            # Envoyer √† l'IA
            user_message = UserMessage(text=enriched_question)
            response = await self.chat.send_message(user_message)
            
            # Sauvegarder la conversation
            await self._save_conversation(question, response)
            
            logger.info(f"‚úÖ Question trait√©e par Assistant IA: {question[:50]}...")
            return response
            
        except Exception as e:
            logger.error(f"‚ùå Erreur Assistant IA: {str(e)}")
            return f"‚ùå D√©sol√© Patrick, j'ai un probl√®me technique. Erreur: {str(e)}"
    
    async def _enrich_question_with_context(self, question: str, context_data: Optional[Dict]) -> str:
        """Enrichir la question avec le contexte des leads actuels"""
        try:
            # R√©cup√©rer les leads r√©cents
            recent_leads = await self.db.leads.find({
                "cr√©√©_le": {"$gte": datetime.now() - timedelta(days=30)}
            }, {"_id": 0}).limit(10).to_list(length=None)
            
            # R√©cup√©rer les analyses IA r√©centes
            recent_analyses = await self.db.ai_analyses.find({
                "created_at": {"$gte": datetime.now() - timedelta(days=7)}
            }, {"_id": 0}).limit(5).to_list(length=None)
            
            # Construire le contexte enrichi
            context = f"""
QUESTION DE PATRICK : {question}

üìä CONTEXTE LEADS ACTUELS ({len(recent_leads)} leads actifs) :
"""
            
            for lead in recent_leads[:5]:  # Top 5 pour √©viter overflow
                context += f"""
- {lead.get('pr√©nom', '')} {lead.get('nom', '')} 
  ‚Ä¢ {lead.get('ville', '')} {lead.get('code_postal', '')}
  ‚Ä¢ Source: {lead.get('source', '')} | Statut: {lead.get('statut', '')}
  ‚Ä¢ T√©l: {lead.get('t√©l√©phone', '')} | Score: {lead.get('score_qualification', 0)}/100
  ‚Ä¢ Cr√©√©: {lead.get('cr√©√©_le', '').strftime('%d/%m') if lead.get('cr√©√©_le') else 'N/A'}
"""
            
            if recent_analyses:
                context += f"\nüß† ANALYSES IA R√âCENTES :"
                for analysis in recent_analyses[:3]:
                    anal_data = analysis.get('analysis', {})
                    context += f"""
- Lead analys√©: {anal_data.get('intention_vente', '')} | Prob: {anal_data.get('probabilite_vente', 0)*100:.0f}%
- Recommandations: {', '.join(anal_data.get('recommandations', [])[:2])}
"""
            
            # Ajouter donn√©es contextuelles si fournies
            if context_data:
                context += f"\nüìã CONTEXTE SP√âCIFIQUE :\n{context_data}"
            
            context += f"\n\n‚ö° Maintenant r√©ponds √† Patrick avec des conseils pr√©cis et actionnables !"
            
            return context
            
        except Exception as e:
            logger.error(f"‚ùå Erreur enrichissement contexte: {str(e)}")
            return question  # Fallback sur question originale
    
    async def _save_conversation(self, question: str, response: str):
        """Sauvegarder la conversation pour historique"""
        try:
            conversation = {
                "id": str(uuid.uuid4()),
                "user": "Patrick Almeida",
                "question": question,
                "response": response,
                "timestamp": datetime.now(),
                "session": "efficity-assistant"
            }
            
            await self.db.assistant_conversations.insert_one(conversation)
            
        except Exception as e:
            logger.error(f"‚ùå Erreur sauvegarde conversation: {str(e)}")
    
    async def get_daily_briefing(self) -> str:
        """G√©n√©rer le briefing quotidien pour Patrick"""
        try:
            briefing_question = """
            Donne-moi mon briefing quotidien Efficity :
            - Quels leads je dois contacter aujourd'hui en priorit√© ?
            - Quelles sont mes meilleures opportunit√©s ?
            - Y a-t-il des urgences ou actions critiques ?
            - R√©sum√© de mes performances cette semaine
            
            Format le comme un briefing de directeur d'agence, avec priorit√©s claires et actions pr√©cises.
            """
            
            return await self.ask_assistant(briefing_question)
            
        except Exception as e:
            logger.error(f"‚ùå Erreur briefing quotidien: {str(e)}")
            return "‚ùå Erreur g√©n√©ration briefing quotidien"
    
    async def analyze_lead_potential(self, lead_id: str) -> str:
        """Analyser le potentiel sp√©cifique d'un lead"""
        try:
            # R√©cup√©rer le lead
            lead = await self.db.leads.find_one({"id": lead_id}, {"_id": 0})
            if not lead:
                return "‚ùå Lead non trouv√©"
            
            # R√©cup√©rer l'analyse IA si disponible
            ai_analysis = await self.db.ai_analyses.find_one({"lead_id": lead_id}, {"_id": 0})
            
            question = f"""
            Analyse-moi en d√©tail le potentiel de ce lead :
            
            {lead.get('pr√©nom')} {lead.get('nom')} - {lead.get('ville')} {lead.get('code_postal')}
            Source: {lead.get('source')} | Statut: {lead.get('statut')}
            Budget: {lead.get('budget_min', 0)}‚Ç¨ - {lead.get('budget_max', 0)}‚Ç¨
            Notes: {lead.get('notes_commerciales', 'Aucune')}
            
            Donne-moi :
            1. Potentiel de commission estim√©
            2. Meilleure strat√©gie d'approche 
            3. Timing optimal pour le contacter
            4. Points de n√©gociation √† aborder
            5. Risques et opportunit√©s
            """
            
            context = {"lead_data": lead, "ai_analysis": ai_analysis}
            return await self.ask_assistant(question, context)
            
        except Exception as e:
            logger.error(f"‚ùå Erreur analyse lead {lead_id}: {str(e)}")
            return f"‚ùå Erreur analyse du lead: {str(e)}"
    
    async def get_conversation_history(self, limit: int = 10) -> List[Dict]:
        """R√©cup√©rer l'historique des conversations"""
        try:
            conversations = await self.db.assistant_conversations.find(
                {"user": "Patrick Almeida"},
                {"_id": 0}
            ).sort("timestamp", -1).limit(limit).to_list(length=None)
            
            return conversations
            
        except Exception as e:
            logger.error(f"‚ùå Erreur r√©cup√©ration historique: {str(e)}")
            return []
    
    async def suggest_market_opportunities(self) -> str:
        """Sugg√©rer des opportunit√©s march√© bas√©es sur les donn√©es"""
        try:
            question = """
            Bas√© sur mes leads actuels et le march√© Lyon, quelles sont les opportunit√©s √† saisir ?
            
            Analyse :
            - Secteurs g√©ographiques les plus prometteurs
            - Types de biens √† privil√©gier  
            - Timing optimal pour la prospection
            - Sources de leads √† d√©velopper
            - Actions marketing recommand√©es
            
            Donne des conseils concrets pour d√©velopper mon CA Efficity.
            """
            
            return await self.ask_assistant(question)
            
        except Exception as e:
            logger.error(f"‚ùå Erreur suggestions march√©: {str(e)}")
            return "‚ùå Erreur g√©n√©ration suggestions march√©"

# Instance globale de l'assistant
efficity_assistant = None

def get_assistant_instance(db: AsyncIOMotorDatabase) -> EfficityAIAssistant:
    """Obtenir l'instance de l'assistant (singleton)"""
    global efficity_assistant
    if efficity_assistant is None:
        efficity_assistant = EfficityAIAssistant(db)
    return efficity_assistant